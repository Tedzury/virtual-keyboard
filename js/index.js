const keyboard = {
  Backquote: {
    ru: {
      type: 'regular',
      main: 'ё',
    },
    en: {
      type: 'shiftable',
      main: '`',
      shift: '~',
    },
  },
  Digit1: {
    ru: {
      type: 'shiftable',
      main: '1',
      shift: '!',
    },
    en: {
      type: 'shiftable',
      main: '1',
      shift: '!',
    },
  },
  Digit2: {
    ru: {
      type: 'shiftable',
      main: '2',
      shift: '"',
    },
    en: {
      type: 'shiftable',
      main: '2',
      shift: '@',
    },
  },
  Digit3: {
    ru: {
      type: 'shiftable',
      main: '3',
      shift: '№',
    },
    en: {
      type: 'shiftable',
      main: '3',
      shift: '#',
    },
  },
  Digit4: {
    ru: {
      type: 'shiftable',
      main: '4',
      shift: ';',
    },
    en: {
      type: 'shiftable',
      main: '4',
      shift: '$',
    },
  },
  Digit5: {
    ru: {
      type: 'shiftable',
      main: '5',
      shift: '%',
    },
    en: {
      type: 'shiftable',
      main: '5',
      shift: '%',
    },
  },
  Digit6: {
    ru: {
      type: 'shiftable',
      main: '6',
      shift: ':',
    },
    en: {
      type: 'shiftable',
      main: '6',
      shift: '^',
    },
  },
  Digit7: {
    ru: {
      type: 'shiftable',
      main: '7',
      shift: '?',
    },
    en: {
      type: 'shiftable',
      main: '7',
      shift: '&',
    },
  },
  Digit8: {
    ru: {
      type: 'shiftable',
      main: '8',
      shift: '*',
    },
    en: {
      type: 'shiftable',
      main: '8',
      shift: '*',
    },
  },
  Digit9: {
    ru: {
      type: 'shiftable',
      main: '9',
      shift: '(',
    },
    en: {
      type: 'shiftable',
      main: '9',
      shift: '(',
    },
  },
  Digit0: {
    ru: {
      type: 'shiftable',
      main: '0',
      shift: ')',
    },
    en: {
      type: 'shiftable',
      main: '0',
      shift: ')',
    },
  },
  Minus: {
    ru: {
      type: 'shiftable',
      main: '-',
      shift: '_',
    },
    en: {
      type: 'shiftable',
      main: '-',
      shift: '_',
    },
  },
  Equal: {
    ru: {
      type: 'shiftable',
      main: '=',
      shift: '+',
    },
    en: {
      type: 'shiftable',
      main: '=',
      shift: '+',
    },
  },
  Backspace: {
    ru: {
      type: 'functional',
      main: 'Backspace',
    },
    en: {
      type: 'functional',
      main: 'Backspace',
    },
  },
  Tab: {
    ru: {
      type: 'spacing',
      main: 'Tab',
    },
    en: {
      type: 'spacing',
      main: 'Tab',
    },
  },
  KeyQ: {
    ru: {
      type: 'regular',
      main: 'й',
    },
    en: {
      type: 'regular',
      main: 'q',
    },
  },
  KeyW: {
    ru: {
      type: 'regular',
      main: 'ц',
    },
    en: {
      type: 'regular',
      main: 'w',
    },
  },
  KeyE: {
    ru: {
      type: 'regular',
      main: 'у',
    },
    en: {
      type: 'regular',
      main: 'e',
    },
  },
  KeyR: {
    ru: {
      type: 'regular',
      main: 'к',
    },
    en: {
      type: 'regular',
      main: 'r',
    },
  },
  KeyT: {
    ru: {
      type: 'regular',
      main: 'е',
    },
    en: {
      type: 'regular',
      main: 't',
    },
  },
  KeyY: {
    ru: {
      type: 'regular',
      main: 'н',
    },
    en: {
      type: 'regular',
      main: 'y',
    },
  },
  KeyU: {
    ru: {
      type: 'regular',
      main: 'г',
    },
    en: {
      type: 'regular',
      main: 'u',
    },
  },
  KeyI: {
    ru: {
      type: 'regular',
      main: 'ш',
    },
    en: {
      type: 'regular',
      main: 'i',
    },
  },
  KeyO: {
    ru: {
      type: 'regular',
      main: 'щ',
    },
    en: {
      type: 'regular',
      main: 'o',
    },
  },
  KeyP: {
    ru: {
      type: 'regular',
      main: 'з',
    },
    en: {
      type: 'regular',
      main: 'p',
    },
  },
  BracketLeft: {
    ru: {
      type: 'regular',
      main: 'х',
    },
    en: {
      type: 'shiftable',
      main: '[',
      shift: '{',
    },
  },
  BracketRight: {
    ru: {
      type: 'regular',
      main: 'ъ',
    },
    en: {
      type: 'shiftable',
      main: ']',
      shift: '}',
    },
  },
  Backslash: {
    ru: {
      type: 'shiftable',
      main: '\\',
      shift: '/',
    },
    en: {
      type: 'shiftable',
      main: '\\',
      shift: '|',
    },
  },
  Delete: {
    ru: {
      type: 'functional',
      main: 'Delete',
    },
    en: {
      type: 'functional',
      main: 'Delete',
    },
  },
  CapsLock: {
    ru: {
      type: 'functional',
      main: 'CapsLock',
    },
    en: {
      type: 'functional',
      main: 'CapsLock',
    },
  },
  KeyA: {
    ru: {
      type: 'regular',
      main: 'ф',
    },
    en: {
      type: 'regular',
      main: 'a',
    },
  },
  KeyS: {
    ru: {
      type: 'regular',
      main: 'ы',
    },
    en: {
      type: 'regular',
      main: 's',
    },
  },
  KeyD: {
    ru: {
      type: 'regular',
      main: 'в',
    },
    en: {
      type: 'regular',
      main: 'd',
    },
  },
  KeyF: {
    ru: {
      type: 'regular',
      main: 'а',
    },
    en: {
      type: 'regular',
      main: 'f',
    },
  },
  KeyG: {
    ru: {
      type: 'regular',
      main: 'п',
    },
    en: {
      type: 'regular',
      main: 'g',
    },
  },
  KeyH: {
    ru: {
      type: 'regular',
      main: 'р',
    },
    en: {
      type: 'regular',
      main: 'h',
    },
  },
  KeyJ: {
    ru: {
      type: 'regular',
      main: 'о',
    },
    en: {
      type: 'regular',
      main: 'j',
    },
  },
  KeyK: {
    ru: {
      type: 'regular',
      main: 'л',
    },
    en: {
      type: 'regular',
      main: 'k',
    },
  },
  KeyL: {
    ru: {
      type: 'regular',
      main: 'д',
    },
    en: {
      type: 'regular',
      main: 'l',
    },
  },
  Semicolon: {
    ru: {
      type: 'regular',
      main: 'ж',
    },
    en: {
      type: 'shiftable',
      main: ';',
      shift: ':',
    },
  },
  Quote: {
    ru: {
      type: 'regular',
      main: 'э',
    },
    en: {
      type: 'shiftable',
      main: '\'',
      shift: '"',
    },
  },
  Enter: {
    ru: {
      type: 'spacing',
      main: 'Enter',
    },
    en: {
      type: 'spacing',
      main: 'Enter',
    },
  },
  ShiftLeft: {
    ru: {
      type: 'functional',
      main: 'Shift',
    },
    en: {
      type: 'functional',
      main: 'Shift',
    },
  },
  KeyZ: {
    ru: {
      type: 'regular',
      main: 'я',
    },
    en: {
      type: 'regular',
      main: 'z',
    },
  },
  KeyX: {
    ru: {
      type: 'regular',
      main: 'ч',
    },
    en: {
      type: 'regular',
      main: 'x',
    },
  },
  KeyC: {
    ru: {
      type: 'regular',
      main: 'с',
    },
    en: {
      type: 'regular',
      main: 'c',
    },
  },
  KeyV: {
    ru: {
      type: 'regular',
      main: 'м',
    },
    en: {
      type: 'regular',
      main: 'v',
    },
  },
  KeyB: {
    ru: {
      type: 'regular',
      main: 'и',
    },
    en: {
      type: 'regular',
      main: 'b',
    },
  },
  KeyN: {
    ru: {
      type: 'regular',
      main: 'т',
    },
    en: {
      type: 'regular',
      main: 'n',
    },
  },
  KeyM: {
    ru: {
      type: 'regular',
      main: 'ь',
    },
    en: {
      type: 'regular',
      main: 'm',
    },
  },
  Comma: {
    ru: {
      type: 'regular',
      main: 'б',
    },
    en: {
      type: 'shiftable',
      main: ',',
      shift: '<',
    },
  },
  Period: {
    ru: {
      type: 'regular',
      main: 'ю',
    },
    en: {
      type: 'shiftable',
      main: '.',
      shift: '>',
    },
  },
  Slash: {
    ru: {
      type: 'shiftable',
      main: '.',
      shift: ',',
    },
    en: {
      type: 'shiftable',
      main: '/',
      shift: '?',
    },
  },
  ArrowUp: {
    ru: {
      type: 'regular',
      main: '↑',

    },
    en: {
      type: 'regular',
      main: '↑',
    },
  },
  ShiftRight: {
    ru: {
      type: 'functional',
      main: 'Shift',
    },
    en: {
      type: 'functional',
      main: 'Shift',
    },
  },
  ControlLeft: {
    ru: {
      type: 'functional',
      main: 'Ctrl',
    },
    en: {
      type: 'functional',
      main: 'Ctrl',
    },
  },
  MetaLeft: {
    ru: {
      type: 'functional',
      main: 'Win',
    },
    en: {
      type: 'functional',
      main: 'Win',
    },
  },
  AltLeft: {
    ru: {
      type: 'functional',
      main: 'Alt',
    },
    en: {
      type: 'functional',
      main: 'Alt',
    },
  },
  Space: {
    ru: {
      type: 'spacing',
      main: 'Space',
    },
    en: {
      type: 'spacing',
      main: 'Space',
    },
  },
  AltRight: {
    ru: {
      type: 'functional',
      main: 'Alt',
    },
    en: {
      type: 'functional',
      main: 'Alt',
    },
  },
  ArrowLeft: {
    ru: {
      type: 'regular',
      main: '←',
    },
    en: {
      type: 'regular',
      main: '←',
    },
  },
  ArrowDown: {
    ru: {
      type: 'regular',
      main: '↓',
    },
    en: {
      type: 'regular',
      main: '↓',
    },
  },
  ArrowRight: {
    ru: {
      type: 'regular',
      main: '→',
    },
    en: {
      type: 'regular',
      main: '→',
    },
  },
  ControlRight: {
    ru: {
      type: 'functional',
      main: 'Ctrl',
    },
    en: {
      type: 'functional',
      main: 'Ctrl',
    },
  },
};

let language = localStorage.getItem('language') ? localStorage.getItem('language') : 'en';
localStorage.setItem('language', language);
let isCapsLock = false;
const keysArray = Object.keys(keyboard);
let keyNodes;

const body = document.querySelector('#body');
const textArea = document.createElement('textarea');
const keyboardWrapper = document.createElement('div');

textArea.classList.add('text-area');
keyboardWrapper.classList.add('key-wrapp');
textArea.textContent = '';

body.append(textArea);
body.append(keyboardWrapper);

function prepareKeyboardLayout() {
  keyboardWrapper.innerHTML = '';
  keysArray.forEach((key) => {
    const keyBoardKey = document.createElement('div');
    keyBoardKey.classList.add('key');
    keyBoardKey.setAttribute('data-key-code', key);
    keyBoardKey.setAttribute('data-key-type', keyboard[key][language].type);
    keyBoardKey.textContent = keyboard[key][language].main;
    keyboardWrapper.append(keyBoardKey);
  });
  keyNodes = Array.from(document.querySelectorAll('.key'));
}

/* eslint-disable no-param-reassign */
function backspace() {
  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  textArea.value = textArea.value
    .slice(0, start === end ? start - 1 : start) + textArea.value.slice(end);

  textArea.selectionStart = start === end ? start - 1 : start;
  textArea.selectionEnd = textArea.selectionStart;
}
function deleteChar() {
  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  if (!(textArea.value.length > end)) return;

  textArea.value = textArea.value.slice(0, start) + textArea.value.slice(end + 1);
  textArea.selectionStart = start;
  textArea.selectionEnd = textArea.selectionStart;
}
function insertSpaces(e) {
  let space;
  if (e.code === 'Tab') space = '\t';
  if (e.code === 'Enter') space = '\n';
  if (e.code === 'Space') space = ' ';

  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  textArea.value = textArea.value.slice(0, start) + space + textArea.value.slice(end);

  textArea.selectionStart = start + 1;
  textArea.selectionEnd = textArea.selectionStart;
}
function modifyTextArea(e) {
  const char = keyNodes.find((elem) => elem.dataset.keyCode === e.code).textContent;

  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  textArea.value = textArea.value.slice(0, start) + char + textArea.value.slice(end);

  textArea.selectionStart = start + 1;
  textArea.selectionEnd = textArea.selectionStart;
}
function changeLang(e) {
  if (e.ctrlKey && e.altKey) {
    language = (language === 'en' ? 'ru' : 'en');
    localStorage.setItem('language', language);
    prepareKeyboardLayout();
  }
}
function shift() {
  keyNodes.forEach((key) => {
    if (key.dataset.keyType === 'shiftable') {
      const { keyCode } = key.dataset;
      key.textContent = key.textContent === keyboard[keyCode][language].shift
        ? keyboard[keyCode][language].main : keyboard[keyCode][language].shift;
    }
    if (isCapsLock && key.dataset.keyType === 'regular') {
      key.textContent = key.textContent === key.textContent.toLowerCase()
        ? key.textContent.toUpperCase() : key.textContent.toLowerCase();
    } else if (!isCapsLock && key.dataset.keyType === 'regular') {
      key.textContent = key.textContent === key.textContent.toUpperCase()
        ? key.textContent.toLowerCase() : key.textContent.toUpperCase();
    }
  });
}
function capsLock() {
  isCapsLock = !isCapsLock;
  keyNodes.forEach((key) => {
    if (isCapsLock && key.dataset.keyType === 'regular') {
      key.textContent = key.textContent.toUpperCase();
    } else if (key.dataset.keyType === 'regular') {
      key.textContent = key.textContent.toLowerCase();
      document.querySelector('[data-key-code="CapsLock"]').classList.remove('key_active');
    }
  });
}
/* eslint-enable no-param-reassign */

function keyStrokeHandler(e) {
  document.querySelector(`[data-key-code="${e.code}"]`).classList.add('key_active');

  if (e.code === 'ShiftRight' || e.code === 'ShiftLeft') {
    shift();
  }
  if (e.code === 'CapsLock') {
    capsLock();
  }
  if (e.key === 'Alt' || e.key === 'Control') {
    changeLang(e);
  }
  if (e.code === 'Backspace') {
    backspace();
  }
  if (e.code === 'Delete') {
    deleteChar();
  }
  const keyType = keyboard[e.code][language].type;
  if (keyType === 'regular' || keyType === 'shiftable') {
    modifyTextArea(e);
  }
  if (keyType === 'spacing') {
    insertSpaces(e);
  }
}
function keyUpHandler(e) {
  if (e.code !== 'CapsLock') document.querySelector(`[data-key-code="${e.code}"]`).classList.remove('key_active');
  if (e.code === 'ShiftRight' || e.code === 'ShiftLeft') {
    shift();
  }
}

body.addEventListener('keydown', (e) => {
  if (keysArray.indexOf(e.code) > -1) {
    e.preventDefault();
    keyStrokeHandler(e);
  }
});
body.addEventListener('keyup', (e) => {
  if (keysArray.indexOf(e.code) > -1) {
    e.preventDefault();
    keyUpHandler(e);
  }
});
body.addEventListener('mousedown', (e) => {
  body.dispatchEvent(new KeyboardEvent('keydown', { code: e.target.dataset.keyCode }));
});
body.addEventListener('mouseup', (e) => {
  body.dispatchEvent(new KeyboardEvent('keyup', { code: e.target.dataset.keyCode }));
});

setInterval(() => {
  textArea.focus();
}, 0);

prepareKeyboardLayout();
